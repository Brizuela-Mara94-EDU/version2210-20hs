<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <title>Experiencia AR - Dinos</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <link rel="stylesheet" href="/AppMindAr/style.css">
  <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.4.5/aframe/build/aframe-ar.js"></script>

</head>

<body>
  <!-- Pantalla inicial -->
  <div class="ui-overlay">
    <div class="intro-animation">
      <h1 class="title-animated">Experiencia AR</h1>
      <div class="subtitle-professional">Realidad Aumentada Interactiva</div>
      <button id="start-button" class="cta-button">🚀 Iniciar</button>
    </div>
  </div>
  
  <!-- Interfaz de escaneo (SIN VIDEO PREVIEW) -->
  <div id="scanning-ui" class="ui-layer hidden">
    <div class="projection-box">
      <div></div>
    </div>
    <div class="search-text">Apunta al centro de un marcador...</div>
  </div>
  
  <!-- Botón flotante para mostrar info -->
  <button id="toggle-info-btn" class="info-button-mobile">
    <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
      <circle cx="12" cy="12" r="10"></circle>
      <line x1="12" y1="16" x2="12" y2="12"></line>
      <line x1="12" y1="8" x2="12.01" y2="8"></line>
    </svg>
  </button>

  <!-- Panel de información -->
  <div id="dino-info-panel" class="hidden">
    <div class="info-content">
      <h3 id="dino-name">Nombre del Modelo</h3>
      <p id="dino-description">Descripción...</p>
      <div class="interaction-buttons">
        <button id="play-sound-btn">🔊 Sonido</button>
        <button id="take-photo-btn">📸 Foto</button>
      </div>
    </div>
    <button id="close-info-btn">✕</button>
  </div>
  
  <!-- Indicadores de Control Interactivo -->
  <div class="control-indicators hidden" id="control-indicators">
    <div class="control-hint">
      <div class="control-icon-wrapper rotate-icon">
        <svg class="rotate-arrows" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
          <path d="M50,20 A30,30 0 1,1 20,50" fill="none" stroke="currentColor" stroke-width="6" stroke-linecap="round"/>
          <polygon points="15,45 20,55 25,45" fill="currentColor"/>
          <path d="M50,80 A30,30 0 1,1 80,50" fill="none" stroke="currentColor" stroke-width="6" stroke-linecap="round"/>
          <polygon points="85,55 80,45 75,55" fill="currentColor"/>
        </svg>
      </div>
      <span id="rotate-hint">Arrastra para girar</span>
    </div>
    <div class="control-hint">
      <div class="control-icon-wrapper zoom-icon">
        <svg class="zoom-symbol" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
          <g class="pinch-gesture">
            <circle cx="35" cy="50" r="8" fill="currentColor"/>
            <circle cx="65" cy="50" r="8" fill="currentColor"/>
            <path d="M35,50 L45,50" stroke="currentColor" stroke-width="3" stroke-dasharray="2,2"/>
            <path d="M55,50 L65,50" stroke="currentColor" stroke-width="3" stroke-dasharray="2,2"/>
          </g>
          <g class="scroll-gesture hidden">
            <rect x="42" y="30" width="16" height="40" rx="8" fill="none" stroke="currentColor" stroke-width="3"/>
            <circle cx="50" cy="45" r="3" fill="currentColor"/>
            <path d="M50,20 L50,30" stroke="currentColor" stroke-width="3" stroke-linecap="round"/>
            <polygon points="50,18 47,23 53,23" fill="currentColor"/>
          </g>
        </svg>
      </div>
      <span id="zoom-hint">Pellizca para zoom</span>
    </div>
  </div>
  
  <!-- Botones de control -->
  <button id="restart-button" class="hidden">🔄</button>
  
  <!-- Contenedor AR -->
  <div id="ar-container"></div>
  <div id="detection-status" class="detection-status hidden">Dino: Inactivo</div>

<script>
  const startButton = document.querySelector("#start-button");
  const arContainer = document.querySelector("#ar-container");
  const scanningUI = document.querySelector("#scanning-ui");
  const restartButton = document.querySelector("#restart-button");
  const dinoInfoPanel = document.querySelector("#dino-info-panel");
  const closeInfoButton = document.querySelector("#close-info-btn");
  const playSoundButton = document.querySelector("#play-sound-btn");
  const detectionStatus = document.querySelector("#detection-status");
  const controlIndicators = document.querySelector("#control-indicators");
  const rotateHint = document.querySelector("#rotate-hint");
  const zoomHint = document.querySelector("#zoom-hint");
  const toggleInfoBtn = document.querySelector('#toggle-info-btn');

  let sceneEl;
  let hintTimeout;
  let isModelPlaced = false;
  let currentModel = null;

  let isRotating = false;
  let lastX = 0;
  let lastY = 0;
  let rotationVelocityY = 0;
  let rotationVelocityX = 0;
  let currentRotationY = 0;
  let currentRotationX = 0;
  let currentScale = 1;
  let initialPinchDistance = 0;
  let initialScale = 1;
  let touches = [];

  const modelInfo = {
    0: { 
      name: "Brachiosaurus", 
      emoji: "🦕", 
      description: "Gigante herbívoro de cuello largo.",
      scale: "0.065 0.065 0.05",
      scaleMobile: "0.05 0.05 0.04",
      position: "0 -0.62 -1.75",
      positionMobile: "0 -0.3 -1.75", 
      rotation: "0 300 0"
    },
    1: { 
      name: "Tyrannosaurus Rex", 
      emoji: "🦖", 
      description: "El rey de los depredadores.",
      scale: "0.15 0.15 0.15",
      scaleMobile: "0.1 0.1 0.1",
      position: "0 -0.4 -1.7",
      rotation: "0 90 0"
    },
    2: { 
      name: "Triceratops", 
      emoji: "🦏", 
      description: "Herbívoro con tres cuernos.",
      scale: "1 1 0.75",
      scaleMobile: "0.4 0.4 0.4",
      position: "0 -0.1 -1.5",
      rotation: "0 45 0"
    },
    3: { 
      name: "Velociraptor", 
      emoji: "🦎", 
      description: "Cazador inteligente y ágil.",
      scale: "0.35 0.35 0.35",
      scaleMobile: "0.15 0.15 0.15",
      position: "0 -0.3 -1.5",
      rotation: "0 0 0"
    },
    4: { 
      name: "Stegosaurio", 
      emoji: "🦕", 
      description: "Dinosaurio herbívoro del período Jurásico con placas óseas distintivas.",
      scale: "0.2 0.2 0.2",
      scaleMobile: "0.1 0.1 0.10",
      position: "0 -0.1 -1.5",
      rotation: "0 0 0"
    },
    5: { 
      name: "Anquilosaurio", 
      emoji: "🛡️", 
      description: "Conocido como el 'tanque viviente' del Cretácico.",
      scale: "0.2 0.2 0.2",
      scaleMobile: "0.0022 0.0022 0.0022",
      position: "0 -0.1 -1.5",
      positionMobile: "0 -0.1 -1.75",
      rotation: "0 0 0"
    }
  };

  const roarAudio = new Audio('/AppMindAr/sounds/roar.mp3');
  const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

  function setupInteractiveControls(model) {
    currentModel = model;
    
    const initialRotation = model.getAttribute('rotation');
    currentRotationY = parseFloat(initialRotation.y) || 0;
    currentRotationX = parseFloat(initialRotation.x) || 0;
    
    const pinchGesture = document.querySelector('.pinch-gesture');
    const scrollGesture = document.querySelector('.scroll-gesture');
    
    if (!isMobile) {
      rotateHint.textContent = "Clic y arrastra para girar";
      zoomHint.textContent = "Rueda del mouse para zoom";
      if (pinchGesture) pinchGesture.classList.add('hidden');
      if (scrollGesture) scrollGesture.classList.remove('hidden');
    } else {
      rotateHint.textContent = "Arrastra para girar";
      zoomHint.textContent = "Pellizca para zoom";
      if (pinchGesture) pinchGesture.classList.remove('hidden');
      if (scrollGesture) scrollGesture.classList.add('hidden');
    }
    
    document.addEventListener('touchstart', handleTouchStart, { passive: false });
    document.addEventListener('touchmove', handleTouchMove, { passive: false });
    document.addEventListener('touchend', handleTouchEnd, { passive: false });
    document.addEventListener('mousedown', handleMouseDown);
    document.addEventListener('mousemove', handleMouseMove);
    document.addEventListener('mouseup', handleMouseUp);
    document.addEventListener('wheel', handleWheel, { passive: false });
    
    animateInertia();
    showTemporaryHints();
  }

  function showTemporaryHints() {
    clearTimeout(hintTimeout); 
    if (controlIndicators) {
      controlIndicators.classList.remove('hidden'); 
      controlIndicators.classList.add('visible');
    }
    
    hintTimeout = setTimeout(() => {
      if (controlIndicators) {
        controlIndicators.classList.remove('visible');
        setTimeout(() => {
          controlIndicators.classList.add('hidden');
        }, 500);
      }
    }, 5000);
  }

  function removeInteractiveControls() {
    document.removeEventListener('touchstart', handleTouchStart);
    document.removeEventListener('touchmove', handleTouchMove);
    document.removeEventListener('touchend', handleTouchEnd);
    document.removeEventListener('mousedown', handleMouseDown);
    document.removeEventListener('mousemove', handleMouseMove);
    document.removeEventListener('mouseup', handleMouseUp);
    document.removeEventListener('wheel', handleWheel);
    
    if (controlIndicators) {
      controlIndicators.classList.remove('visible');
      controlIndicators.classList.add('hidden');
    }
    currentModel = null;
  }

  function handleTouchStart(e) {
    if (!currentModel || e.target.closest('button') || e.target.closest('#dino-info-panel')) return;
    
    touches = Array.from(e.touches);
    
    if (touches.length === 1) {
      lastX = touches[0].clientX;
      lastY = touches[0].clientY;
      isRotating = true;
      rotationVelocityY = 0;
      rotationVelocityX = 0;
    } else if (touches.length === 2) {
      e.preventDefault();
      initialPinchDistance = getPinchDistance(touches);
      initialScale = currentScale;
    }
  }

  function handleTouchMove(e) {
    if (!currentModel) return;
    
    touches = Array.from(e.touches);
    
    if (touches.length === 1 && isRotating) {
      const deltaX = touches[0].clientX - lastX;
      const deltaY = touches[0].clientY - lastY;
      
      rotationVelocityY = deltaX * 0.5;
      rotationVelocityX = deltaY * 0.3;
      
      currentRotationY += rotationVelocityY;
      currentRotationX -= rotationVelocityX;
      currentRotationX = Math.max(-45, Math.min(45, currentRotationX));
      
      updateModelRotation();
      
      lastX = touches[0].clientX;
      lastY = touches[0].clientY;
    } else if (touches.length === 2) {
      e.preventDefault();
      const currentPinchDistance = getPinchDistance(touches);
      const scaleChange = currentPinchDistance / initialPinchDistance;
      currentScale = Math.max(0.3, Math.min(2.5, initialScale * scaleChange));
      updateModelScale();
    }
  }

  function handleTouchEnd(e) {
    touches = Array.from(e.touches);
    
    if (touches.length < 2) {
      initialPinchDistance = 0;
    }
    
    if (touches.length === 0) {
      isRotating = false;
    }
  }

  function handleMouseDown(e) {
    if (!currentModel || e.target.closest('button') || e.target.closest('#dino-info-panel')) return;
    
    isRotating = true;
    lastX = e.clientX;
    lastY = e.clientY;
    rotationVelocityY = 0;
    rotationVelocityX = 0;
    e.preventDefault();
  }

  function handleMouseMove(e) {
    if (!currentModel || !isRotating) return;
    
    const deltaX = e.clientX - lastX;
    const deltaY = e.clientY - lastY;
    
    rotationVelocityY = deltaX * 0.5;
    rotationVelocityX = deltaY * 0.3;
    
    currentRotationY += rotationVelocityY;
    currentRotationX -= rotationVelocityX;
    currentRotationX = Math.max(-45, Math.min(45, currentRotationX));
    
    updateModelRotation();
    
    lastX = e.clientX;
    lastY = e.clientY;
  }

  function handleMouseUp(e) {
    isRotating = false;
  }

  function handleWheel(e) {
    if (!currentModel) return;
    e.preventDefault();
    
    const delta = e.deltaY * -0.001;
    currentScale = Math.max(0.3, Math.min(2.5, currentScale + delta));
    updateModelScale();
  }

  function getPinchDistance(touches) {
    const dx = touches[0].clientX - touches[1].clientX;
    const dy = touches[0].clientY - touches[1].clientY;
    return Math.sqrt(dx * dx + dy * dy);
  }

  function updateModelRotation() {
    if (!currentModel) return;
    currentModel.setAttribute('rotation', `${currentRotationX} ${currentRotationY} 0`);
  }

  function updateModelScale() {
    if (!currentModel) return;
    const baseScale = currentModel.getAttribute('data-base-scale');
    const scales = baseScale.split(' ').map(s => parseFloat(s) * currentScale);
    currentModel.setAttribute('scale', scales.join(' '));
  }

  function animateInertia() {
    if (currentModel && !isRotating) {
      rotationVelocityY *= 0.95;
      rotationVelocityX *= 0.95;
      
      if (Math.abs(rotationVelocityY) > 0.1 || Math.abs(rotationVelocityX) > 0.1) {
        currentRotationY += rotationVelocityY;
        currentRotationX -= rotationVelocityX;
        currentRotationX = Math.max(-45, Math.min(45, currentRotationX));
        updateModelRotation();
      }
    }
    
    requestAnimationFrame(animateInertia);
  }

  function updateDetectionStatus(message) {
    if (detectionStatus) {
      detectionStatus.textContent = message;
      detectionStatus.classList.remove('hidden');
    }
  }

  function showInfoButton() {
    console.log('🔘 showInfoButton llamada - isMobile:', isMobile);
    
    if (isMobile && toggleInfoBtn) {
      toggleInfoBtn.classList.remove('info-button-mobile');
      toggleInfoBtn.classList.add('info-button-visible');
      console.log('✅ Botón flotante activado para móvil');
    }
  }

  function hideInfoButton() {
    if (toggleInfoBtn) {
      toggleInfoBtn.classList.remove('info-button-visible');
      toggleInfoBtn.classList.add('info-button-mobile');
    }
  }

  function hideModelInfo() { 
    if (dinoInfoPanel) dinoInfoPanel.classList.add('hidden'); 
  }

  startButton.addEventListener("click", () => {
    document.querySelector(".ui-overlay").style.display = "none";
    if (scanningUI) scanningUI.classList.remove("hidden");
    if (detectionStatus) detectionStatus.classList.remove("hidden");
    
    initAR();
  });

  function initAR() {
    if (sceneEl && sceneEl.parentNode) {
      arContainer.removeChild(sceneEl);
    }
    
    sceneEl = document.createElement('a-scene');
    
    const arjsConfig = [
      `sourceType: webcam`,
      `sourceWidth: ${isMobile ? 640 : 1280}`,
      `sourceHeight: ${isMobile ? 480 : 960}`,
      `displayWidth: ${isMobile ? 640 : 1280}`,
      `displayHeight: ${isMobile ? 480 : 960}`,
      `trackingMethod: best`,
      `detectionMode: mono_and_matrix`,
      `matrixCodeType: 3x3`,
      `debugUIEnabled: false`,
      `minConfidence: 0.15`,
      `maxDetectionRate: 90`,
      `canvasWidth: ${isMobile ? 480 : 640}`,
      `canvasHeight: ${isMobile ? 360 : 480}`,
      `cameraParametersUrl: https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.4.5/data/data/camera_para.dat`
    ].join('; ');
    
    sceneEl.setAttribute('arjs', arjsConfig);
    sceneEl.setAttribute('renderer', 'logarithmicDepthBuffer: true; colorManagement: true; antialias: true; physicallyCorrectLights: true;');
    sceneEl.setAttribute('vr-mode-ui', 'enabled: false');
    sceneEl.setAttribute('embedded', '');
    sceneEl.setAttribute('loading-screen', 'enabled: false');

    arContainer.appendChild(sceneEl);
    
    const baseURL = `${window.location.origin}/AppMindAr/docs/models/`;

    const assets = document.createElement('a-assets');
    assets.innerHTML = `
      <a-asset-item id="brachiosaurus" crossorigin="anonymous" src="${baseURL}brachiosaurus.glb"></a-asset-item>
      <a-asset-item id="trex" crossorigin="anonymous" src="${baseURL}trex.glb"></a-asset-item>
      <a-asset-item id="triceratops" crossorigin="anonymous" src="${baseURL}triceratops.glb"></a-asset-item>
      <a-asset-item id="velociraptor" crossorigin="anonymous" src="${baseURL}velociraptor.glb"></a-asset-item>
      <a-asset-item id="stegosaurio" crossorigin="anonymous" src="${baseURL}stegosaurio.glb"></a-asset-item>
      <a-asset-item id="ankylosaurio" crossorigin="anonymous" src="${baseURL}ankylosaurus.glb"></a-asset-item>
    `;
    sceneEl.appendChild(assets);



    const ambientLight = document.createElement('a-light');
    ambientLight.setAttribute('type', 'ambient');
    ambientLight.setAttribute('color', '#FFF');
    ambientLight.setAttribute('intensity', '1.2');
    sceneEl.appendChild(ambientLight);

    const directionalLight = document.createElement('a-light');
    directionalLight.setAttribute('type', 'directional');
    directionalLight.setAttribute('color', '#FFF');
    directionalLight.setAttribute('intensity', '1.5');
    directionalLight.setAttribute('position', '-1 1 1');
    sceneEl.appendChild(directionalLight);

    const directionalLight2 = document.createElement('a-light');
    directionalLight2.setAttribute('type', 'directional');
    directionalLight2.setAttribute('color', '#FFF');
    directionalLight2.setAttribute('intensity', '0.8');
    directionalLight2.setAttribute('position', '1 1 -1');
    sceneEl.appendChild(directionalLight2);

    for (let i = 0; i <= 5; i++) {
      const marker = document.createElement('a-marker');
      marker.setAttribute('class', 'dino-marker');
      marker.setAttribute('data-model-index', i);
      marker.setAttribute('type', 'barcode');
      marker.setAttribute('value', i);
      marker.setAttribute('emitevents', 'true');
      marker.setAttribute('smooth', 'true');
      marker.setAttribute('smoothCount', i === 1 ? '3' : '5');
      marker.setAttribute('smoothTolerance', i === 1 ? '0.005' : '0.01');
      marker.setAttribute('smoothThreshold', i === 1 ? '1' : '2');
      sceneEl.appendChild(marker);
    }

    const camera = document.createElement('a-entity');
    camera.setAttribute('camera', '');
    sceneEl.appendChild(camera);
    
    updateDetectionStatus("Buscando marcadores...");
    isModelPlaced = false;

    sceneEl.addEventListener('loaded', () => {
      updateDetectionStatus("Listo para escanear");
      
      const markers = document.querySelectorAll('.dino-marker');
      markers.forEach(marker => {
        marker.addEventListener('markerFound', (event) => {
          if (isModelPlaced) return;
          
          const modelIndex = marker.getAttribute('data-model-index');
          console.log('🦖 Marcador encontrado:', modelIndex);
          updateDetectionStatus(`¡Eureka! Dino ${modelIndex} encontrado!`);
          
          const modelConfig = modelInfo[modelIndex];
          if (!modelConfig) return;
          
          const scaleToUse = isMobile ? modelConfig.scaleMobile : modelConfig.scale;
          const positionToUse = isMobile && modelConfig.positionMobile ? modelConfig.positionMobile : modelConfig.position;
          
          const placedModel = document.createElement('a-entity');
          placedModel.setAttribute('class', 'placed-model');
          placedModel.setAttribute('gltf-model', getModelFile(modelIndex));
          placedModel.setAttribute('scale', scaleToUse);
          placedModel.setAttribute('data-base-scale', scaleToUse);
          placedModel.setAttribute('rotation', modelConfig.rotation);
          placedModel.setAttribute('animation-mixer', '');
          
          const camera = document.querySelector('a-entity[camera]');
          placedModel.setAttribute('position', positionToUse);
          camera.appendChild(placedModel);
          
          isModelPlaced = true;
          currentScale = 1;
          
          setupInteractiveControls(placedModel);
          
          if (scanningUI) scanningUI.classList.add("hidden");
          if (restartButton) restartButton.classList.remove("hidden");
          
          showInfoButton();
          
          const info = modelInfo[modelIndex];
          if (info) {
            document.getElementById('dino-name').textContent = `${info.emoji} ${info.name}`;
            document.getElementById('dino-description').textContent = info.description;
            
            if (!isMobile) {
              dinoInfoPanel.classList.remove('hidden');
              console.log('📱 Panel mostrado en desktop');
            } else {
              console.log('📱 Esperando interacción del botón en móvil');
            }
          }
          
          try {
            roarAudio.currentTime = 0;
            roarAudio.play().catch(e => console.log('Error al reproducir audio:', e));
          } catch(e) {
            console.log('Error con audio:', e);
          }
        });
        
        marker.addEventListener('markerLost', () => {
          const modelIndex = marker.getAttribute('data-model-index');
          console.log('Marcador perdido:', modelIndex);
        });
      });
    });

    sceneEl.addEventListener('arjs-video-loaded', (event) => {
      console.log('✅ Video AR.js cargado correctamente');
      updateDetectionStatus("Cámara activa - Busca un marcador");
    });
    
    sceneEl.addEventListener('camera-error', (error) => {
      console.error('❌ Error de cámara AR.js:', error);
      updateDetectionStatus("Error: No se puede acceder a la cámara");
    });
  }

  if (restartButton) {
    restartButton.addEventListener("click", () => {
      isModelPlaced = false;
      
      removeInteractiveControls();
      
      const placedModels = document.querySelectorAll('.placed-model');
      placedModels.forEach(model => {
        if (model && model.parentNode) {
          model.parentNode.removeChild(model);
        }
      });
      
      hideModelInfo();
      hideInfoButton();
      if (scanningUI) scanningUI.classList.remove("hidden");
      if (restartButton) restartButton.classList.add("hidden");
      
      try {
        roarAudio.pause();
      } catch(e) {
        console.log('Error al pausar audio:', e);
      }

      updateDetectionStatus("Buscando marcadores...");
    });
  }

  if (playSoundButton) {
    playSoundButton.addEventListener('click', () => {
      try {
        roarAudio.currentTime = 0;
        roarAudio.play().catch(e => console.log('Error al reproducir audio:', e));
      } catch(e) {
        console.log('Error con audio:', e);
      }
    });
  }

  const takePhotoBtn = document.querySelector("#take-photo-btn");
  if (takePhotoBtn) {
    takePhotoBtn.addEventListener("click", () => {
      try {
        const scene = document.querySelector('a-scene');
        if (scene && scene.components.screenshot) {
          scene.components.screenshot.capture('perspective');
          alert("¡Foto capturada!");
        } else {
          alert("Función de foto - implementación pendiente");
        }
      } catch(e) {
        console.log('Error al tomar foto:', e);
        alert("Función de foto - implementación pendiente");
      }
    });
  }

  function getModelFile(index) {
    const files = {
      0: "#brachiosaurus",
      1: "#trex",
      2: "#triceratops",
      3: "#velociraptor",
      4: "#stegosaurio",
      5: "#ankylosaurio"
    };
    return files[index] || files[0];
  }

  if (toggleInfoBtn && dinoInfoPanel) {
    toggleInfoBtn.addEventListener('click', () => {
      console.log('🔘 Botón presionado');
      dinoInfoPanel.classList.remove('hidden');
      hideInfoButton();
    });
  }

  if (closeInfoButton && dinoInfoPanel) {
    closeInfoButton.addEventListener('click', () => {
      dinoInfoPanel.classList.add('hidden');
      
      if (isMobile) {
        showInfoButton();
      }
    });
  }
</script>

</body>
</html>